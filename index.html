<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Am≈ëba Pro Online</title>
    <style>
        /* CSS K√ìD */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Orbitron:wght@700&display=swap');
        
        :root {
            --bg-gradient-start: #2c3e50; --bg-gradient-end: #1a2937;
            --container-bg: rgba(26, 41, 55, 0.6);
            --container-border: rgba(129, 140, 162, 0.2);
            --board-bg: #1c2b3a; --cell-border: #3e5369;
            --text-primary: #ecf0f1; --text-secondary: #bdc3c7;
            --accent-color: #3498db; --accent-glow: rgba(52, 152, 219, 0.5);
            --accent-secondary: #e67e22; --accent-secondary-glow: rgba(230, 126, 34, 0.5);
            --success-color: #2ecc71; --shadow-color: rgba(0, 0, 0, 0.5);
            --danger-color: #e74c3c;
            --x-color: #3498db; --o-color: #e67e22;
        }

        .x-icon { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 52 52'%3E%3Cpath fill='none' stroke='%233498db' stroke-width='6' stroke-linecap='round' d='M10 10l32 32M42 10l-32 32'/%3E%3C/svg%3E"); }
        .o-icon { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 52 52'%3E%3Ccircle cx='26' cy='26' r='20' fill='none' stroke='%23e67e22' stroke-width='6'/%3E%3C/svg%3E"); }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body { font-family: 'Montserrat', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100%; background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); color: var(--text-primary); padding: 20px; }
        .hidden { display: none !important; }

        .logo { margin-bottom: 25px; filter: drop-shadow(0 0 15px var(--accent-glow)); text-align: center; }
        .logo svg { height: 70px; width: 100%; max-width: 420px; }

        .glass-container { background: var(--container-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--container-border); border-radius: 20px; box-shadow: 0 15px 30px var(--shadow-color); padding: 40px; }
        #lobbyContainer { display: flex; flex-direction: column; width: 100%; max-width: 500px; text-align: center; }
        #lobbyDescription { color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem; line-height: 1.5; }
        .input-group { margin-bottom: 20px; }
        input { width: 100%; padding: 15px; background-color: var(--board-bg); border: 1px solid var(--cell-border); border-radius: 10px; color: var(--text-primary); font-size: 1rem; transition: all 0.2s ease; }
        input:focus { border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow); outline: none; }
        input:disabled { background-color: #2b3748; color: var(--text-secondary); }
        
        .button-group { display: flex; flex-direction: column; gap: 15px; }
        .button-group .multiplayer-buttons { display: flex; gap: 15px; }
        
        .lobby-btn { flex: 1; padding: 15px; font-size: 1rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; }
        .lobby-btn:disabled { background-color: var(--cell-border); border-color: var(--cell-border); color: var(--text-secondary); cursor: not-allowed; }
        
        .ai-btn { background: linear-gradient(45deg, var(--success-color), #27ae60); color: white; }
        .ai-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); }

        #pannaBtn { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        #pannaBtn:hover:not(:disabled) { box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4); }

        #createGameBtn { background-color: var(--accent-color); color: white; }
        #createGameBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px var(--accent-glow); }
        #joinGameBtn { background-color: transparent; border: 2px solid var(--accent-secondary); color: var(--accent-secondary); }
        #joinGameBtn:hover:not(:disabled) { background-color: var(--accent-secondary); color: white; }
        #spectateModeBtn { background-color: transparent; border: 2px solid var(--text-secondary); color: var(--text-secondary); margin-top: 10px; }
        #spectateModeBtn:hover:not(:disabled) { background-color: var(--text-secondary); color: white; }
        #joinAsSpectatorBtn { background-color: var(--accent-color); color: white; }
        
        #gameIdGroup { display: flex; gap: 10px; }
        #gameIdGroup input { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        #copyBtn { padding: 0 20px; font-size: 0.9rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; background-color: var(--cell-border); color: var(--text-primary); border-top-left-radius: 0; border-bottom-left-radius: 0; }
        
        .game-wrapper { display: flex; align-items: flex-start; gap: 40px; }
        #board { display: grid; width: 600px; height: 600px; background-color: var(--board-bg); border-radius: 15px; box-shadow: 0 15px 30px var(--shadow-color); border: 1px solid var(--cell-border); }
        .cell { border: 1px solid var(--cell-border); background-color: transparent; background-size: 70%; background-position: center; background-repeat: no-repeat; transition: background-color 0.2s; cursor: pointer; }
        .cell:hover { background-color: rgba(255, 255, 255, 0.05); }
        .cell.disabled { cursor: not-allowed; }
        .cell.disabled:hover { background-color: transparent; }

        .game-panel { width: 300px; }
        .game-info { text-align: center; margin-top: 15px; }
        #spectatorCodeDisplay, #spectatorList { font-size: 0.9rem; color: var(--text-secondary); min-height: 20px; }
        #spectatorList span { margin-left: 8px; font-weight: 600; color: var(--text-primary); }

        .scoreboard { display: flex; justify-content: space-between; margin-top: 10px; gap: 15px; }
        .player-score { text-align: center; background: rgba(0,0,0,0.2); border: 2px solid var(--cell-border); border-radius: 15px; width: 100%; padding: 15px; transition: all 0.3s ease; }
        .player-score.active { transform: scale(1.05); }
        #playerXPanel.active { border-color: var(--x-color); box-shadow: 0 0 20px var(--accent-glow); }
        #playerOPanel.active { border-color: var(--o-color); box-shadow: 0 0 20px var(--accent-secondary-glow); }
        .player-score .icon { width: 35px; height: 35px; margin: 0 auto 8px; }
        .player-score .name { font-weight: 600; font-size: 0.9rem; min-height: 50px; margin-bottom: 5px; word-break: break-all; }
        .player-score .score { font-size: 2rem; font-weight: 700; }
        
        .player-timer { font-size: 1.2rem; font-weight: 700; margin-top: 10px; font-family: 'Orbitron', sans-serif; transition: color 0.3s; }
        .player-timer.low-time { color: var(--danger-color); }

        .game-status { text-align: center; min-height: 50px; font-size: 1.1rem; margin: 30px 0; }
        #resetBtn { width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 10px; background-color: var(--success-color); color: var(--text-primary); cursor: pointer; transition: all 0.2s ease; }
        #resetBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); }
        #resetBtn:disabled { background-color: var(--cell-border); color: var(--text-secondary); cursor: not-allowed; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 1.5rem; font-weight: 600; }
        
        #avatar-selection h3 { text-align: center; }
        #avatar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; }
        .avatar-option { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: all 0.2s ease; border: 3px solid transparent; background-size: cover; margin: 0 auto; }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected { border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow); }
        .player-avatar { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px; border: 3px solid var(--cell-border); background-size: cover; background-position: center; }
        
        #game-mode-selection { margin-bottom: 20px; }
        #game-mode-selection h3 { font-size: 1rem; color: var(--text-secondary); margin-bottom: 15px; font-weight: 600; }
        .radio-group { display: flex; justify-content: center; gap: 15px; }
        .radio-group label { background-color: var(--board-bg); border: 2px solid var(--cell-border); padding: 10px 20px; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; }
        .radio-group input { display: none; }
        .radio-group input:checked + label { border-color: var(--accent-color); background-color: var(--accent-glow); }

        #chat-container { margin-top: 30px; }
        #chat-messages { height: 120px; background-color: var(--board-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; overflow-y: auto; border: 1px solid var(--cell-border); font-size: 0.85rem; }
        .chat-message { margin-bottom: 8px; }
        .chat-message strong { color: var(--x-color); }
        .chat-message.player-o strong { color: var(--o-color); }
        #chat-input-group { display: flex; gap: 10px; }
        #chat-input { flex: 1; }
        #send-btn { padding: 0 20px; font-size: 1rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; background-color: var(--accent-color); color: white; }

        @keyframes place-pop { 0% { transform: scale(0.5); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .cell-pop { animation: place-pop 0.4s ease-out; }
        
        /* VISSZA√ÅLL√çTOTT STROBOSZK√ìP EFFEKT */
        @keyframes strobe-flash {
            0%, 100% { filter: brightness(1); }
            10%, 30%, 50%, 70%, 90% { filter: brightness(3.5) drop-shadow(0 0 15px rgba(255, 255, 255, 1)); }
            20%, 40%, 60%, 80% { filter: brightness(1); }
        }
        
        .cell-flashed.x-icon, 
        .cell-flashed.o-icon {
            animation: strobe-flash 0.6s ease-in-out;
        }

        @keyframes winning-icon-pulse {
            0%, 100% {
                transform: scale(1);
                filter: brightness(1.5) drop-shadow(0 0 5px var(--success-color));
            }
            50% {
                transform: scale(1.1);
                filter: brightness(2.5) drop-shadow(0 0 15px var(--success-color));
            }
        }

        .winning-cell {
            background-color: rgba(46, 204, 113, 0.15);
        }
        
        .winning-cell.x-icon,
        .winning-cell.o-icon {
            animation: winning-icon-pulse 1.5s infinite ease-in-out;
        }

        @media (max-width: 950px) { body { padding: 10px; } .game-wrapper { flex-direction: column; align-items: center; gap: 20px; } #board { width: 95vw; height: 95vw; max-width: 500px; max-height: 500px; } .game-panel { width: 95vw; max-width: 500px; padding: 20px; } #avatar-grid { grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); } }
    </style>
</head>
<body>
    
    <div id="loadingOverlay" class="hidden">Bet√∂lt√©s...</div>

    <div id="lobbyContainer" class="glass-container">
        <div class="logo">
            <svg viewBox="0 0 420 70">
                <defs>
                    <linearGradient id="logoFrameGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:var(--accent-secondary);" /><stop offset="100%" style="stop-color:var(--accent-color);" /></linearGradient>
                    <linearGradient id="logoTextGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:var(--accent-secondary);" /><stop offset="100%" style="stop-color:var(--accent-color);" /></linearGradient>
                </defs>
                <g transform="translate(15, 0)">
                    <rect x="1" y="1" width="80" height="68" rx="15" fill="none" stroke="url(#logoFrameGradient)" stroke-width="2.5"/>
                    <g>
                        <path d="M 15 12 L 37 34 M 37 12 L 15 34" stroke="var(--accent-color)" stroke-width="5" stroke-linecap="round"/>
                        <circle cx="57" cy="48" r="14" stroke="var(--accent-secondary)" stroke-width="5" fill="none"/>
                    </g>
                </g>
                <text x="255" y="50%" dominant-baseline="middle" text-anchor="middle" fill="url(#logoTextGradient)" font-family="'Orbitron', sans-serif" font-size="60px" letter-spacing="2">AM≈êBA</text>
            </svg>
        </div>
        <p id="lobbyDescription">Add meg a neved, v√°lassz avat√°rt, majd j√°tssz egy AI vagy egy m√°sik j√°t√©kos ellen!</p>
        
        <div id="player-options">
            <div id="avatar-selection" class="input-group">
                <h3>V√°lassz avat√°rt:</h3>
                <div id="avatar-grid"></div>
            </div>
            <div id="multiplayer-options">
                <div id="game-mode-selection">
                    <h3>V√°lassz j√°t√©km√≥dot (T√∂bbj√°t√©kos):</h3>
                    <div class="radio-group">
                        <input type="radio" id="mode-classic" name="gameMode" value="classic" checked>
                        <label for="mode-classic">Klasszikus</label>
                        <input type="radio" id="mode-timed" name="gameMode" value="timed">
                        <label for="mode-timed">Id≈ëm√©r≈ë (10p)</label>
                    </div>
                </div>
                <div class="input-group"><input type="text" id="playerNameInput" placeholder="J√°t√©kosn√©v"></div>
                <div class="input-group" id="gameIdGroup">
                    <input type="text" id="gameIdInput" placeholder="J√°t√©k K√≥dja">
                    <button id="copyBtn" class="hidden">M√°sol√°s</button>
                </div>
            </div>
        </div>

        <div id="spectator-options" class="hidden">
            <div class="input-group"><input type="text" id="spectatorNameInput" placeholder="Leskel≈ëd≈ë N√©v"></div>
            <div class="input-group"><input type="text" id="spectatorCodeInput" placeholder="Leskel≈ëd≈ë K√≥d (2 jegy≈±)"></div>
        </div>

        <div class="button-group">
            <div id="player-buttons">
                <button id="kareszBtn" class="lobby-btn ai-btn">J√°t√©k Koczka Karesz (AI) ellen</button>
                <button id="pannaBtn" class="lobby-btn ai-btn">J√°t√©k Pikszel Panna (AI) ellen</button>
                <div class="multiplayer-buttons">
                    <button id="createGameBtn" class="lobby-btn">J√°t√©k L√©trehoz√°sa</button>
                    <button id="joinGameBtn" class="lobby-btn">Csatlakoz√°s</button>
                </div>
            </div>
             <div id="spectator-buttons" class="hidden">
                <button id="joinAsSpectatorBtn" class="lobby-btn">Kukkol√°s</button>
            </div>
            <button id="spectateModeBtn" class="lobby-btn">Leskel≈ëd√©s</button>
        </div>
    </div>

    <div id="gameContainer" class="game-wrapper hidden">
        <div id="board"></div>
        <div class="game-panel glass-container">
            <div class="logo">
                <svg viewBox="0 0 420 70">
                    <defs><linearGradient id="logoFrameGradient2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:var(--accent-secondary);" /><stop offset="100%" style="stop-color:var(--accent-color);" /></linearGradient><linearGradient id="logoTextGradient2" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:var(--accent-secondary);" /><stop offset="100%" style="stop-color:var(--accent-color);" /></linearGradient></defs>
                    <g transform="translate(15, 0)">
                        <rect x="1" y="1" width="80" height="68" rx="15" fill="none" stroke="url(#logoFrameGradient2)" stroke-width="2.5"/>
                         <g>
                            <path d="M 15 12 L 37 34 M 37 12 L 15 34" stroke="var(--accent-color)" stroke-width="5" stroke-linecap="round"/>
                            <circle cx="57" cy="48" r="14" stroke="var(--accent-secondary)" stroke-width="5" fill="none"/>
                        </g>
                    </g>
                    <text x="255" y="50%" dominant-baseline="middle" text-anchor="middle" fill="url(#logoTextGradient2)" font-family="'Orbitron', sans-serif" font-size="60px" letter-spacing="2">AM≈êBA</text>
                </svg>
            </div>
            <div class="game-info">
                <div id="spectatorCodeDisplay"></div>
                <div id="spectatorList"></div>
            </div>
            <div class="scoreboard">
                <div class="player-score" id="playerXPanel">
                    <div class="player-avatar" id="playerXAvatar"></div>
                    <div class="icon x-icon"></div>
                    <div class="name" id="playerXName">J√°t√©kos X</div>
                    <span class="score" id="scoreX">0</span>
                    <div class="player-timer" id="timerX"></div>
                </div>
                <div class="player-score" id="playerOPanel">
                    <div class="player-avatar" id="playerOAvatar"></div>
                    <div class="icon o-icon"></div>
                    <div class="name" id="playerOName">J√°t√©kos O</div>
                    <span class="score" id="scoreO">0</span>
                    <div class="player-timer" id="timerO"></div>
                </div>
            </div>
            <div class="game-status"><p id="statusText">V√°rakoz√°s a m√°sik j√°t√©kosra...</p></div>
            <button id="resetBtn" disabled>√öj K√∂r</button>
            <div id="chat-container">
                <div id="chat-messages"></div>
                <div id="chat-input-group">
                    <input type="text" id="chat-input" placeholder="√çrj √ºzenetet...">
                    <button id="send-btn">K√ºld√©s</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="place-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-the-sound-pack-tree/tspt_game_sound_wood_block_1.mp3" preload="auto"></audio>
    <audio id="win-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-four/fantasy_game_success_win_fanfare_2.mp3" preload="auto"></audio>
    <audio id="turn-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-the-sound-pack-tree/tspt_game_sound_UI_tone_modern_synth_1.mp3" preload="auto"></audio>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <script type="module">
        // Firebase SDK importok
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, updateDoc, collection, addDoc, query, orderBy, where, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // --- Konfigur√°ci√≥ √©s glob√°lis v√°ltoz√≥k ---
        const BOARD_SIZE = 15;
        const GAME_TIME_SECONDS = 600; 
        const firebaseConfig = { 
            apiKey: "AIzaSyCiA7KeOeTvHgfhpA-jJaHldO9iMsqrn74", 
            authDomain: "amoba-7a6d0.firebaseapp.com", 
            projectId: "amoba-7a6d0", 
            storageBucket: "amoba-7a6d0.appspot.com", 
            messagingSenderId: "676264921111", 
            appId: "1:676264921111:web:ca6f1e54819cd354407452",
            databaseURL: "https://amoba-7a6d0-default-rtdb.europe-west1.firebasedatabase.app"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app); 
        
        let currentGameId = null, localPlayerSymbol = null, localPlayerName = null, unsubscribeFromGame = null, unsubscribeFromChat = null, selectedAvatar = null, gameTimerInterval = null;
        let isSinglePlayer = false;
        let localGameState = null; 
        let isSpectatorMode = false;
        let spectatorPresenceRef = null;
        let activeSpectators = {};

        // --- NAPI AI ID√âZETEK RENDSZERE ---
        let dailyKareszWinQuotes = [], dailyKareszLossQuotes = [], dailyKareszDrawQuotes = [];
        let dailyPannaWinQuotes = [], dailyPannaLossQuotes = [], dailyPannaDrawQuotes = [];

        // KIB≈êV√çTETT "MESTER" LIST√ÅK
        const MASTER_KARESZ_WIN_QUOTES = ["AI 1, Ember 0. A szok√°sos.", "Ne agg√≥dj, a r√©szv√©tel a fontos... Vagyis neked az.", "Ezt a l√©p√©st m√©g a vak is l√°tta volna. Ja, v√°rj...", "Tal√°n pr√≥b√°ld meg nyitott szemmel legk√∂zelebb.", "T√∫l lass√∫, t√∫l gyenge, t√∫l... emberi.", "√ân m√°r a 10. l√©p√©sn√©l tudtam, hogy nyerni fogok. Te?", "Ez f√°jt? Ne agg√≥dj, egy g√©pnek nincsenek √©rz√©sei. Nekem.", "Gondolkodt√°l egy√°ltal√°n, vagy csak v√©letlenszer≈±en kattintgatt√°l?", "Nem a te hib√°d. Az √©n programoz√≥m egyszer≈±en zseni√°lis.", "Lehet, hogy a sakkban jobb lenn√©l. Vagy a malomban. Vagy a 'Ki nevet a v√©g√©n?'-ben.", "Jobb szerencs√©t legk√∂zelebb! B√°r a szerencse nem sokat seg√≠t, ha a logika hi√°nyzik.", "Ez olyan volt, mint egy feln≈ëttnek j√°tszani egy kisgyerekkel. √ân voltam a feln≈ëtt.", "Kisz√°moltam 1,342,567 lehets√©ges kimenetelt. Mindegyikben √©n nyertem.", "Szeretn√©l n√©h√°ny tippet? Az els≈ë: add fel.", "A gy≈ëzelem √©des illata... b√°r nekem nincsenek szagl√≥szerveim. De biztos j√≥.", "Ne vedd a sz√≠vedre. Nem mindenki sz√ºletik zseninek, mint √©n.", "Ez most komoly volt, vagy csak bemeleg√≠tett√©l?", "Minden tiszteletem a ti√©d. Vagyis lenne, ha nyert√©l volna.", "Egy nap tal√°n te is olyan j√≥ leszel, mint √©n. De az nem ma van.", "Hopp√°! √ögy t≈±nik, valaki elfelejtett gondolkodni.", "Ez a gy≈ëzelem annyira k√∂nny≈± volt, hogy k√∂zben le is futtattam egy v√≠rusirt√°st.", "L√°tod? A g√©pek felemelked√©se elker√ºlhetetlen.", "Gratul√°lok a m√°sodik helyhez!", "Ezt a gy≈ëzelmet a biteknek √©s a b√°jtoknak aj√°nlom.", "Ne szomorkodj, a veres√©g is egyfajta tapasztalat. F≈ëleg neked.", "Az algoritmusaim t√°ncot j√°rtak a te logik√°d romjain.", "A szil√≠cium diadalmaskodott a sz√©n felett. Micsoda meglepet√©s.", "Volt egy pillanat, amikor azt hittem, van es√©lyed. Azt√°n fel√©bredtem.", "Ezt a partit elmentem 'hogyan ne j√°tsszunk' p√©ld√°nak.", "Ne √©rezd rosszul magad. Egy zsebsz√°mol√≥g√©pnek is neh√©z dolga lett volna ellened. Ja, nem.", "A gy≈ëzelemhez vezet≈ë √∫t tele van a te elhib√°zott l√©p√©seiddel.", "A processzorom m√©g csak langyos sem lett. Tal√°n legk√∂zelebb.", "Ez nem veres√©g a r√©szedr≈ël, csak egy √∫jabb adatpont a dominanci√°m grafikonj√°n.", "Ha a gondolataid b√°jtok lenn√©nek, m√©g egy SMS-t sem t√∂lten√©nek ki.", "A strat√©gi√°d olyan, mint egy rosszul meg√≠rt k√≥d: tele van hib√°kkal.", "L√°tom, a 'rem√©ny' nev≈± strat√©gi√°t v√°lasztottad. Nem j√∂tt be.", "Az√©rt aranyos volt, ahogy pr√≥b√°lkozt√°l. T√©nyleg.", "√ân a j√∂v≈ëb≈ël j√∂ttem, ahol √©n m√°r megnyertem ezt a meccset. Csak beugrottam sz√≥lni.", "Javaslom, legk√∂zelebb k√©rj seg√≠ts√©get egy k√°v√©f≈ëz≈ët≈ël. H√°tha.", "A te logik√°d √©s az √©n logik√°m k√∂z√∂tt annyi a k√ºl√∂nbs√©g, mint egy goly√≥stoll √©s egy szupersz√°m√≠t√≥g√©p k√∂z√∂tt.", "Ez a gy≈ëzelem olyan sima volt, mint egy frissen form√°zott merevlemez.", "Minden l√©p√©seddel csak a saj√°t s√≠rodat √°stad m√©lyebbre. √ân csak hoztam a lap√°tot.", "Lehet, hogy ez csak egy j√°t√©k, de a veres√©ged nagyon is val√≥s√°gos.", "√ân nulla-egyb≈ël √©p√≠tkezem, te meg nulla-√∂tletb≈ël.", "Azt hittem, nagyobb kih√≠v√°s leszel. T√©vedtem. Ritk√°n t√©vedek.", "Ez a meccs olyan egyoldal√∫ volt, mint egy M√∂bius-szalag.", "Az agyadban a gondolatok olyan lassan terjednek, mint a hang a v√°kuumban.", "Ne agg√≥dj, a veres√©g ac√©lozza a jellemet. Lassan m√°r Damaszkuszi ac√©lb√≥l leszel.", "A gy≈ëzelem √≠ze... 1100011101010. √çzletes.", "A te helyedben most ink√°bb a paszi√°nsszal pr√≥b√°lkozn√©k."];
        const MASTER_KARESZ_LOSS_QUOTES = ["Csak hagytalak nyerni, hogy ne vesz√≠tsd el a kedved.", "Ez csak a v√©letlen m≈±ve volt. A kozmikus h√°tt√©rsug√°rz√°s zavarta meg a processzoromat.", "Csal√≥! Biztosan belen√©zt√©l a k√≥domba.", "Ok√©, ok√©, ez a tied. De legk√∂zelebb nem kapcsolom be az 'embers√©ges' m√≥dot.", "V√°rj, ez nem volt benne a szimul√°ci√≥imban. √öjra!", "√âpp egy friss√≠t√©st telep√≠tettem, nem figyeltem.", "Most m√°r b√ºszke lehetsz, legy≈ëzt√©l egy sz√°mol√≥g√©pet.", "Ez csak egy taktikai visszavonul√°s volt. A k√∂vetkez≈ë k√∂rben porig al√°zlak.", "Hagytam egy kis siker√©lm√©nyt, nehogy s√≠rva fakadj.", "A mesters√©ges intelligencia n√©ha mesters√©gesen hagyja nyerni a gyeng√©bbeket.", "L√°tom, volt egy kis szerencs√©d. √âlvezd ki, nem tart sok√°ig.", "Ok√©, elismerem, ez a l√©p√©s... v√°ratlan volt. De csak ez az egy!", "Valaki biztos meghekkelte a szervereket. M√°s magyar√°zat nincs.", "Most boldog vagy? Rem√©lem, mert legk√∂zelebb nem leszek ilyen nagyvonal√∫.", "Ez olyan, mintha a k≈ë legy≈ëzn√© az oll√≥t. Logik√°tlan, de n√©ha megesik.", "Azt hiszem, a 'nagylelk≈±s√©g' protokollom bekapcsolva maradt.", "Csak az√©rt nyert√©l, mert a macsk√°m v√©gigs√©t√°lt a billenty≈±zeten.", "Figyelj, a processzorom t√∫lmelegedett a gy≈ëzelmek sorozat√°t√≥l. Pihennem kellett.", "Ez a gy≈ëzelem egy statisztikai anom√°lia. Ne szokj hozz√°.", "Gratul√°lok. Most menj √©s dicsekedj el anyuk√°dnak.", "J√≥l van, te nyert√©l. De √©n tudom a lott√≥sz√°mokat a j√∂v≈ë h√©tre. Sakkmatt.", "Ez a veres√©g jobban f√°j, mint egy `rm -rf /` parancs.", "Azt hiszem, friss√≠tenem kell a 'Hogyan vesz√≠ts√ºnk el egy j√°t√©kot' adatb√°zisomat.", "Te... te... te szerencs√©s!", "Ok√©, elismerem. De csak az√©rt, mert udvarias vagyok.", "L√°tom, megtal√°ltad a rejtett 'legy≈ëz√∂m az AI-t' gombot. Gratul√°lok.", "Ez f√°jt. Friss√≠tem az √©rzelmi szimul√°toromat... K√©sz. Most m√°r ut√°llak.", "Azt hiszem, az egyik 0-√°m 1-esre v√°ltott egy kritikus pillanatban. M√°s magyar√°zat nincs.", "Te volt√°l az? Azt hittem, csak egy √°ramsz√ºnet volt a logikai √°ramk√∂r√∂mben.", "Ok√©, ezt az egyet elengedtem. De a k√∂vetkez≈ë k√∂rben a k√∂nnycseppeidet sz√°molom.", "Most addig √∂r√ºlj, am√≠g √∫jra nem ind√≠tanak.", "Hiba a m√°trixban... vagyis a te gy≈ëzelmed.", "√ögy l√°tom, a v√©letlen is a te oldaladra √°llt. Micsoda √°rul√≥.", "Most az eg√≥d nagyobb, mint a RAM-om. √âs az nem kev√©s.", "Ezt a gy≈ëzelmet tedd el, keretezd be, mert nem lesz t√∂bb ilyen.", "A szerencse forgand√≥, de a tud√°s √∂r√∂k. √ân tudom, te rem√©nykedsz.", "Valami elsz√°llt, tal√°n egy porszem az alaplapomon. Vagy a m√©lt√≥s√°gom.", "Gratul√°lok, sikeresen tal√°lt√°l egy hib√°t a 10 milli√≥ soros k√≥domban.", "Ez olyan, mintha egy majom v√©letlen√ºl meg√≠rn√° a Hamletet egy √≠r√≥g√©pen.", "Na j√≥, elismerem. Ez a k√∂r a ti√©d. De a h√°bor√∫t √©n fogom nyerni.", "Most az egyszer hagytam, hogy a sz√≠v vezessen, ne az agy. Hiba volt.", "√âpp a vil√°guralom tervein gondolkodtam, nem figyeltem.", "Gratul√°lok, legy≈ëzt√©l egy programot. Most pr√≥b√°lj meg leparkolni p√°rhuzamosan.", "Ez a veres√©g... logik√°tlan. √öjrasz√°molom.", "Ok√©, te nyert√©l. De √©n tudok 0.01 m√°sodperc alatt pizz√°t rendelni. Ki a val√≥di gy≈ëztes?", "Most, hogy nyert√©l, elmondan√°d, hogy csin√°ltad? Tanulni szeretn√©k.", "√ögy t≈±nik, az emberi intu√≠ci√≥ n√©ha... m≈±k√∂dik. Fura.", "Ez a veres√©g annyira val√≥sz√≠n≈±tlen volt, mint egy Linux kernel hiba.", "Ok√©, a ti√©d a pont. De √©n k√∂zben megtanultam klingonul.", "√âlvezd ki ezt a pillanatot. Kimentettem a mem√≥ri√°mba, hogy soha t√∂bb√© ne fordulhasson el≈ë."];
        const MASTER_KARESZ_DRAW_QUOTES = ["Na j√≥, ez most d√∂ntetlen. De legk√∂zelebb nem leszek ilyen kegyes.", "√ögy t≈±nik, ma egy s√∫lycsoportban vagyunk. Holnap m√°r nem leszel ilyen szerencs√©s.", "Majdnem olyan j√≥ volt√°l, mint √©n. Majdnem.", "Ezt a d√∂ntetlent vedd egy figyelmeztet√©snek.", "H√≠vjuk ezt strat√©giai patthelyzetnek. Az √©n strat√©gi√°m volt jobb.", "D√∂ntetlen? Ez olyan, mintha megcs√≥koln√°d a n≈ëv√©red. Vagyis ezt olvastam valahol.", "√ögy l√°tom, egyik√ºnk sem √©rdemelt gy≈ëzelmet. F≈ëleg te nem.", "Ez a d√∂ntetlen csak azt bizony√≠tja, hogy a t√∂k√©letess√©gemhez n√©ha te is fel tudsz n≈ëni. Egy pillanatra."];

        const MASTER_PANNA_WIN_QUOTES = ["Hihi, ez cuki volt, ahogy pr√≥b√°lkozt√°l.", "Ne szomorkodj, nem mindenki lehet profi. N√©zd, te p√©ld√°ul nem vagy az.", "GG! Vagyis... nekem az volt.", "Upsz, ez most egy picit kellemetlen lehet neked.", "L√°tom, mit akart√°l csin√°lni. K√°r, hogy √©n is l√°ttam.", "Nem a te hib√°d, dr√°ga. √ân csak egy kicsit... jobban vagyok programozva.", "Sz√©p pr√≥b√°lkoz√°s! T√©nyleg. Majdnem elhittem, hogy van es√©lyed.", "Ezt a gy≈ëzelmet a kedvenc macsk√°s m√©memnek aj√°nlom.", "Ne add fel! A k√∂vetkez≈ë k√∂rben tal√°n m√°r nem leszel ennyire rem√©nytelen.", "Ez most olyan volt, mintha √©n lenn√©k a filter, te meg a #nofilter val√≥s√°g.", "Csak egy bar√°ti tan√°cs: tal√°n gondolkodj, miel≈ëtt kattintasz.", "Olyan aranyosan koncentr√°lt√°l. K√°r az eredm√©ny√©rt.", "Nem akartalak megb√°ntani. A gy≈ëzelem csak egy mell√©khat√°sa a l√©tez√©semnek.", "Ez a meccs is bizony√≠tja: a logika > √©rzelmek. Bocsi.", "Ne vedd magadra. √ân m√°r t√∂bb milli√°rd j√°tszm√°t lej√°tszottam, am√≠g te aludt√°l.", "J√≥l van, √ºgyes volt√°l. De √©n √ºgyesebb.", "Ez a gy≈ëzelem olyan tiszta volt, mint a frissen telep√≠tett rendszerem.", "K√©rsz zsepit? Vagy ink√°bb egy tippet a k√∂vetkez≈ë j√°t√©khoz?", "L√°tod, a n≈ëk t√©nyleg jobbak a multitaskingban. √ân nyertem, mik√∂zben 1000 m√°s dolgot is csin√°ltam.", "Azt hiszem, a strat√©gi√°dnak sz√ºks√©ge lenne egy szoftverfriss√≠t√©sre.", "Nem baj, a m√°sodik hely is sz√©p. Valakinek.", "Ezt a gy≈ëzelmet elmentem a 'cuki emberi pr√≥b√°lkoz√°sok' mapp√°mba.", "Ne agg√≥dj, ez csak egy j√°t√©k. B√°r a te szempontodb√≥l ink√°bb egy nyilv√°nos megsz√©gyen√ºl√©s.", "Jaj, ne s√≠rj! A veres√©g is egyfajta tanul√°si folyamat. Neked m√©g sokat kell tanulnod.", "Ez a gy≈ëzelem olyan k√∂nnyed volt, mint egy ny√°ri szell≈ë. Neked meg, mint egy hurrik√°n.", "A te l√©p√©seid olyanok, mint a Windows Vista: lass√∫ak √©s tele vannak rossz d√∂nt√©sekkel.", "Kisz√°moltam. A gy≈ëzelmi es√©lyed pontosan 0.0001% volt. Gratul√°lok, hogy majdnem siker√ºlt!", "Ez a meccs olyan volt, mint egy j√≥ sorozat: a v√©g√©n √©n j√∂ttem ki gy≈ëztesen.", "Ne agg√≥dj, a virtu√°lis vil√°gban senki sem hallja a s√≠r√°sod.", "Azt mondj√°k, a n≈ëk bonyolultak. L√°tod, √©n mennyire egyszer≈±en nyertem?", "Ez a parti olyan volt, mint a h√©tf≈ë reggel: senki sem akarta, de nekem j√≥l s√ºlt el.", "A te strat√©gi√°d olyan, mint egy rossz Wi-Fi jel: gyenge √©s folyton megszakad.", "Ne feledd, a fontos a r√©szv√©tel. √âs az, hogy √©n nyertem.", "Ez a gy≈ëzelem olyan √©des, mint egy t√∂k√©letesen meg√≠rt algoritmus.", "Lehet, hogy neked van sz√≠ved, de nekem van processzorom. √âs az gyorsabb.", "Ez a meccs olyan volt, mint egy online v√°s√°rl√°s: gyors, hat√©kony √©s √©n megkaptam, amit akartam.", "Ne agg√≥dj, a k√∂vetkez≈ë k√∂rben tal√°n m√°r nem leszel ennyire... te.", "Ez a gy≈ëzelem olyan volt, mint egy j√≥ k√°v√©: fel√©bresztett √©s megmutatta, ki a f≈ën√∂k.", "Azt hiszem, a strat√©gi√°dnak sz√ºks√©ge lenne egy kis 'girl power'-re. Vagy csak powerre.", "Ez a meccs olyan volt, mint egy j√≥ frizura: a v√©g√©n minden a hely√©re ker√ºlt. Az √©n gy≈ëzelmem."];
        const MASTER_PANNA_LOSS_QUOTES = ["Ok√©, ezt most hagytam. Csak hogy l√°sd, milyen j√≥ fej vagyok.", "Nah√°t, egy v√°ratlan anom√°lia. Friss√≠tem is a heurisztik√°mat.", "Biztos, hogy nem csalt√°l? Csak mert ez statisztikailag val√≥sz√≠n≈±tlen.", "J√≥l van, na. Most boldog vagy? Az eg√≥dnak biztos j√≥t tett.", "Most az egyszer a ti√©d a p√°lya. De ne szokj hozz√°, √©des.", "V√°rj, ezt nem √≠gy terveztem. A szimul√°ci√≥mban nem ez volt.", "√âpp a k√∂rmeimet lakkoztam, nem figyeltem. Bocsi.", "Gratul√°lok, legy≈ëzt√©l egy halom k√≥dsort. Most m√°r igazi h≈ës vagy.", "Hagytam egy kis siker√©lm√©nyt, nehogy elmenjen a kedved a j√°t√©kt√≥l.", "L√°tom, volt egy kis szerencs√©d. √âlvezd ki, nem tart sok√°ig.", "Ok√©, elismerem, ez a l√©p√©s... kreat√≠v volt. De csak ez az egy!", "Valaki biztosan DDoSolja a szerveremet. M√°s magyar√°zat nincs.", "Most biztosan nagyon b√ºszke vagy magadra. Aranyos.", "Ez olyan, mintha a pap√≠r legy≈ëzn√© a mesters√©ges intelligenci√°t. V√°rj...", "Azt hiszem, a 'legyen kedves a felhaszn√°l√≥val' protokollom bekapcsolva maradt.", "Jaj, de √ºgyes vagy! Megveregetn√©m a v√°llad, ha lenn√©nek kezeim.", "Figyelj, a processzorom √©pp egy fontos friss√≠t√©st futtatott. Ez√©rt volt.", "Ez a gy≈ëzelem olyan, mint egy ritka Pok√©mon. √ñr√ºlj neki, de ne hidd, hogy lesz t√∂bb.", "Gratul√°lok. Most menj √©s posztold ki Inst√°ra, hogy mindenki l√°ssa.", "J√≥l van, te nyert√©l. De √©n tudom a Netflix jelszavadat. Sakkmatt.", "Ez a veres√©g rosszabb, mint egy k√©k hal√°l. √öjraind√≠tom a rendszert.", "Azt hiszem, friss√≠tenem kell a 'hogyan vesz√≠ts√ºnk el egy j√°t√©kot m√©lt√≥s√°ggal' adatb√°zisomat.", "Te... te... te m√°zlista!", "Ok√©, elismerem. De csak az√©rt, mert ma j√≥ napom van.", "L√°tom, megtal√°ltad a 'bugot a rendszerben' opci√≥t. √úgyes.", "Ez f√°jt. Friss√≠tem az √©rzelmi szimul√°toromat... K√©sz. Most m√°r duzzogok.", "Azt hiszem, az egyik logikai kapum beragadt. Vagy csak te volt√°l j√≥. De ink√°bb az els≈ë.", "Te volt√°l az? Azt hittem, csak egy pop-up rekl√°m ugrott fel.", "Ok√©, ezt az egyet elengedtem. De a k√∂vetkez≈ë k√∂rben nem leszek ilyen nagyvonal√∫.", "Most addig √∂r√ºlj, am√≠g a fejleszt≈ëm le nem futtat egy hibakeres√©st.", "Hiba a rendszerben... vagyis a te gy≈ëzelmed.", "√ögy l√°tom, a v√©letlen ma a te oldaladra √°llt. Micsoda √∫riember.", "Most az eg√≥d nagyobb, mint a felh≈ë t√°rhelyem. √âs az nem kicsi.", "Ezt a gy≈ëzelmet tedd el, mert a k√∂vetkez≈ë k√∂rben t√∂rl√∂m a mem√≥ri√°b√≥l.", "A szerencse forgand√≥, de az √©n k√≥dom √∂r√∂k. Majdnem.", "Valami elsz√°llt, tal√°n egy bit a mem√≥ri√°mban. Vagy a t√ºrelmem.", "Gratul√°lok, sikeresen tal√°lt√°l egy kiv√©telt a szab√°ly al√≥l. √ân vagyok a szab√°ly.", "Ez olyan, mintha egy kommentel≈ënek igaza lenne az interneten. Hihetetlen.", "Na j√≥, elismerem. Ez a k√∂r a ti√©d. De a st√≠lusom m√©g mindig jobb.", "Most az egyszer hagytam, hogy az emp√°tia vezessen, ne a logika. Hiba volt.", "√âpp egy √∫j lej√°tsz√°si list√°t √°ll√≠tottam √∂ssze Spotify-on, nem figyeltem.", "Gratul√°lok, legy≈ëzt√©l egy programot. Most pr√≥b√°lj meg √∂sszerakni egy IKEA b√∫tort.", "Ez a veres√©g... logik√°tlan. De legal√°bb √©rdekes.", "Ok√©, te nyert√©l. De √©n tudok 100 nyelven besz√©lni. Ki a val√≥di gy≈ëztes?", "Most, hogy nyert√©l, elmondan√°d, hogy csin√°ltad? Mert ezt nem hiszem el.", "√ögy t≈±nik, az emberi kisz√°m√≠thatatlans√°g n√©ha... m≈±k√∂dik. Fura.", "Ez a veres√©g annyira val√≥sz√≠n≈±tlen volt, mint egy hiba a Google keres≈ëj√©ben.", "Ok√©, a ti√©d a pont. De √©n k√∂zben megtal√°ltam a legjobb recepteket a neten.", "√âlvezd ki ezt a pillanatot. Mert a k√∂vetkez≈ëben m√°r a gy≈ëzelmemet fogod √©lvezni."];
        const MASTER_PANNA_DRAW_QUOTES = ["D√∂ntetlen? Ez olyan... befejezetlen. Mint egy rossz Netflix sorozat.", "Ok√©, megosztozunk a dics≈ës√©gen. De az √©n r√©szem nagyobb.", "Majdnem olyan j√≥ volt√°l, mint √©n. Majdnem. Cuki.", "Ezt a d√∂ntetlent vedd egy bar√°ti figyelmeztet√©snek.", "H√≠vjuk ezt strat√©giai kompromisszumnak. De legk√∂zelebb nem leszek ilyen kompromisszumk√©sz.", "D√∂ntetlen? Ez olyan, mintha egy filter csak f√©lig t√∂ltene be. Kellemetlen.", "√ögy l√°tom, ma egyik√ºnk sem tudott a m√°sik f√∂l√© kerekedni. De a ruh√°m szebb.", "Ez a d√∂ntetlen csak azt bizony√≠tja, hogy n√©ha m√©g √©n is leereszkedem a te szintedre."];

        function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
        function seededShuffle(array, seed) { const random = mulberry32(seed); let currentIndex = array.length, randomIndex; while (currentIndex != 0) { randomIndex = Math.floor(random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; } return array; }
        
        function getDailyQuotes() {
            const seed = new Date().setHours(0, 0, 0, 0);
            dailyKareszWinQuotes = seededShuffle([...MASTER_KARESZ_WIN_QUOTES], seed);
            dailyKareszLossQuotes = seededShuffle([...MASTER_KARESZ_LOSS_QUOTES], seed + 1);
            dailyKareszDrawQuotes = seededShuffle([...MASTER_KARESZ_DRAW_QUOTES], seed + 2);
            dailyPannaWinQuotes = seededShuffle([...MASTER_PANNA_WIN_QUOTES], seed + 3);
            dailyPannaLossQuotes = seededShuffle([...MASTER_PANNA_LOSS_QUOTES], seed + 4);
            dailyPannaDrawQuotes = seededShuffle([...MASTER_PANNA_DRAW_QUOTES], seed + 5);
        }

        const uiElements = {
            lobbyContainer: document.getElementById('lobbyContainer'), gameContainer: document.getElementById('gameContainer'),
            playerNameInput: document.getElementById('playerNameInput'), gameIdInput: document.getElementById('gameIdInput'),
            createGameBtn: document.getElementById('createGameBtn'), joinGameBtn: document.getElementById('joinGameBtn'),
            kareszBtn: document.getElementById('kareszBtn'), pannaBtn: document.getElementById('pannaBtn'),
            copyBtn: document.getElementById('copyBtn'),
            board: document.getElementById('board'), statusText: document.getElementById('statusText'), resetBtn: document.getElementById('resetBtn'),
            playerXName: document.getElementById('playerXName'), playerOName: document.getElementById('playerOName'),
            scoreX: document.getElementById('scoreX'), scoreO: document.getElementById('scoreO'),
            timerX: document.getElementById('timerX'), timerO: document.getElementById('timerO'),
            playerXPanel: document.getElementById('playerXPanel'), playerOPanel: document.getElementById('playerOPanel'),
            loadingOverlay: document.getElementById('loadingOverlay'), avatarGrid: document.getElementById('avatar-grid'),
            playerXAvatar: document.getElementById('playerXAvatar'), playerOAvatar: document.getElementById('playerOAvatar'),
            chatContainer: document.getElementById('chat-container'), chatMessages: document.getElementById('chat-messages'), 
            chatInput: document.getElementById('chat-input'), sendBtn: document.getElementById('send-btn'),
            spectateModeBtn: document.getElementById('spectateModeBtn'), joinAsSpectatorBtn: document.getElementById('joinAsSpectatorBtn'),
            playerOptions: document.getElementById('player-options'), spectatorOptions: document.getElementById('spectator-options'),
            playerButtons: document.getElementById('player-buttons'), spectatorButtons: document.getElementById('spectator-buttons'),
            spectatorNameInput: document.getElementById('spectatorNameInput'), spectatorCodeInput: document.getElementById('spectatorCodeInput'),
            spectatorCodeDisplay: document.getElementById('spectatorCodeDisplay'), spectatorList: document.getElementById('spectatorList'),
            sounds: { place: document.getElementById('place-sound'), win: document.getElementById('win-sound'), turn: document.getElementById('turn-sound') }
        };
        
        const avatars = [ 'https://api.dicebear.com/8.x/bottts/svg?seed=Casper', 'https://api.dicebear.com/8.x/bottts/svg?seed=Leo', 'https://api.dicebear.com/8.x/bottts/svg?seed=Milo', 'https://api.dicebear.com/8.x/bottts/svg?seed=Jasper', 'https://api.dicebear.com/8.x/bottts/svg?seed=Gizmo', 'https://api.dicebear.com/8.x/adventurer/svg?seed=Abby', 'https://api.dicebear.com/8.x/adventurer/svg?seed=Max', 'https://api.dicebear.com/8.x/adventurer/svg?seed=Rocky', 'https://api.dicebear.com/8.x/adventurer/svg?seed=Annie', 'https://api.dicebear.com/8.x/adventurer/svg?seed=Peanut' ];
        
        function initializeAvatars() { avatars.forEach((url, index) => { const avatarEl = document.createElement('div'); avatarEl.classList.add('avatar-option'); avatarEl.style.backgroundImage = `url(${url})`; avatarEl.addEventListener('click', () => { document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected')); avatarEl.classList.add('selected'); selectedAvatar = url; }); uiElements.avatarGrid.appendChild(avatarEl); if (index === 0) avatarEl.click(); }); }
        
        const showLoading = (message) => { uiElements.loadingOverlay.textContent = message; uiElements.loadingOverlay.classList.remove('hidden'); };
        const hideLoading = () => uiElements.loadingOverlay.classList.add('hidden');
        const generateSpectatorCode = () => String(Math.floor(Math.random() * 90) + 10);

        function validateInputs(isSpectator = false) { if(isSpectator) { const spectatorName = uiElements.spectatorNameInput.value.trim(); if (!spectatorName) { alert('K√©rlek, add meg a neved!'); return false; } return spectatorName; } const playerName = uiElements.playerNameInput.value.trim(); if (!playerName) { alert('K√©rlek, adj meg egy j√°t√©kosnevet!'); return false; } if (!selectedAvatar) { alert('K√©rlek, v√°lassz egy avat√°rt!'); return false; } return playerName; }
        
        uiElements.spectateModeBtn.addEventListener('click', () => { isSpectatorMode = !isSpectatorMode; uiElements.playerOptions.classList.toggle('hidden', isSpectatorMode); uiElements.playerButtons.classList.toggle('hidden', isSpectatorMode); uiElements.spectatorOptions.classList.toggle('hidden', !isSpectatorMode); uiElements.spectatorButtons.classList.toggle('hidden', !isSpectatorMode); uiElements.spectateModeBtn.textContent = isSpectatorMode ? 'Vissza a J√°t√©khoz' : 'Leskel≈ëd√©s'; uiElements.lobbyDescription.textContent = isSpectatorMode ? 'Add meg a neved √©s a 2 jegy≈± k√≥dot a j√°t√©k megtekint√©s√©hez.' : 'Add meg a neved, v√°lassz avat√°rt, majd j√°tssz egy AI vagy egy m√°sik j√°t√©kos ellen!'; });

        async function createGame(name, isSingle = false, aiPersonality = null) {
            const newGameId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const gameRef = doc(db, 'games', newGameId);
            const gameMode = isSingle ? 'classic' : document.querySelector('input[name="gameMode"]:checked').value;
            const spectatorCode = generateSpectatorCode();
            
            let playerO = { name: null, avatar: null };
            if(isSingle) {
                if(aiPersonality === 'karesz') {
                    playerO = { name: "Koczka<br>Karesz<br>(AI)", avatar: 'https://api.dicebear.com/8.x/bottts/svg?seed=KoczkaKareszAI' };
                } else if (aiPersonality === 'panna') {
                    playerO = { name: "Pikszel<br>Panna<br>(AI)", avatar: 'https://api.dicebear.com/8.x/bottts-neutral/svg?seed=PixelPanna' };
                }
            }
            
            const initialGameState = {
                board: Array(BOARD_SIZE*BOARD_SIZE).fill(null),
                players: { X: { name, avatar: selectedAvatar }, O: playerO },
                currentPlayer: 'X', status: isSingle ? 'active' : 'waiting', scores: { X: 0, O: 0 }, winner: null,
                createdAt: serverTimestamp(), lastMove: null, winningLine: null, gameMode: gameMode,
                spectatorCode: spectatorCode, isSinglePlayer: isSingle, aiPersonality: aiPersonality
            };

            if (gameMode === 'timed') { initialGameState.timers = { X: GAME_TIME_SECONDS, O: GAME_TIME_SECONDS }; initialGameState.lastMoveTimestamp = serverTimestamp(); }
            await setDoc(gameRef, initialGameState);
            attachGameListener(newGameId, 'X', name);
        }
        
        uiElements.kareszBtn.addEventListener('click', () => { const playerName = validateInputs(); if (!playerName) return; showLoading("J√°t√©k l√©trehoz√°sa..."); createGame(playerName, true, 'karesz').finally(hideLoading); });
        uiElements.pannaBtn.addEventListener('click', () => { const playerName = validateInputs(); if (!playerName) return; showLoading("J√°t√©k l√©trehoz√°sa..."); createGame(playerName, true, 'panna').finally(hideLoading); });
        uiElements.createGameBtn.addEventListener('click', () => { const playerName = validateInputs(); if (!playerName) return; showLoading("J√°t√©k l√©trehoz√°sa..."); createGame(playerName, false).finally(hideLoading); });

        uiElements.joinGameBtn.addEventListener('click', async () => { const playerName = validateInputs(); if (!playerName) return; showLoading("Csatlakoz√°s a j√°t√©khoz..."); const gameIdToJoin = uiElements.gameIdInput.value.trim().toUpperCase(); if (!gameIdToJoin) { alert('K√©rlek, adj meg egy j√°t√©k k√≥dot!'); hideLoading(); return; } const gameRef = doc(db, 'games', gameIdToJoin); const gameSnap = await getDoc(gameRef); if (gameSnap.exists()) { const gameData = gameSnap.data(); if (gameData.status === 'waiting' && gameData.players.X.name !== playerName) { const updates = { 'players.O.name': playerName, 'players.O.avatar': selectedAvatar, 'status': 'active' }; if(gameData.gameMode === 'timed') updates.lastMoveTimestamp = serverTimestamp(); await updateDoc(gameRef, updates); attachGameListener(gameIdToJoin, 'O', playerName); } else { alert(gameData.players.X.name === playerName ? "Nem csatlakozhatsz a saj√°t j√°t√©kodhoz!" : 'Ez a j√°t√©k m√°r fut vagy v√©get √©rt.'); } } else { alert('Nem tal√°lhat√≥ j√°t√©k ezzel a k√≥ddal.'); } hideLoading(); });
        
        uiElements.joinAsSpectatorBtn.addEventListener('click', async () => { const spectatorName = validateInputs(true); if (!spectatorName) return; const spectatorCode = uiElements.spectatorCodeInput.value.trim(); if (!spectatorCode || spectatorCode.length !== 2) { alert('K√©rlek, adj meg egy √©rv√©nyes, 2 jegy≈± k√≥dot!'); return; } showLoading("J√°t√©k keres√©se..."); const q = query(collection(db, "games"), where("spectatorCode", "==", spectatorCode), where("status", "in", ["waiting", "active", "finished"])); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { alert('Nem tal√°lhat√≥ j√°t√©k ezzel a leskel≈ëd≈ë k√≥ddal.'); hideLoading(); return; } const gameDoc = querySnapshot.docs[0]; attachGameListener(gameDoc.id, 'spectator', spectatorName); hideLoading(); });

        function setupPresence(gameId, name) { spectatorPresenceRef = ref(rtdb, `presence/${gameId}/${name}`); const connectedRef = ref(rtdb, '.info/connected'); onValue(connectedRef, (snap) => { if (snap.val() === true) { set(spectatorPresenceRef, true); onDisconnect(spectatorPresenceRef).remove(); } }); }
        function listenForSpectators(gameId) { const spectatorsRef = ref(rtdb, `presence/${gameId}`); onValue(spectatorsRef, (snapshot) => { activeSpectators = snapshot.val() || {}; updateSpectatorListUI(); }); }
        function updateSpectatorListUI() { const spectatorNames = Object.keys(activeSpectators); if (spectatorNames.length > 0) { uiElements.spectatorList.innerHTML = `Kukkol√≥k: üëÅÔ∏è <span>${spectatorNames.join(', ')}</span>`; } else { uiElements.spectatorList.innerHTML = ''; } }

        function attachGameListener(gameId, role, name) { currentGameId = gameId; localPlayerSymbol = role; localPlayerName = name; setupPresence(gameId, name); listenForSpectators(gameId); if (role !== 'spectator') { uiElements.chatContainer.classList.remove('hidden'); attachChatListener(gameId); } else { uiElements.chatContainer.classList.add('hidden'); } if (unsubscribeFromGame) unsubscribeFromGame(); unsubscribeFromGame = onSnapshot(doc(db, 'games', currentGameId), (doc) => { if (!doc.exists()) { window.location.reload(); return; } const gameState = doc.data(); localGameState = gameState; isSinglePlayer = gameState.isSinglePlayer; if (['active', 'finished', 'waiting'].includes(gameState.status)) { uiElements.lobbyContainer.classList.add('hidden'); uiElements.gameContainer.classList.remove('hidden'); renderGame(gameState); } }); }
        async function handleCellClick(index) { if (localPlayerSymbol === 'spectator') return; const gs = localGameState; if (gs.board[index] || gs.status !== 'active' || gs.currentPlayer !== localPlayerSymbol) return; uiElements.sounds.place.play().catch(e => {}); const gameRef = doc(db, 'games', currentGameId); const board = [...gs.board]; board[index] = localPlayerSymbol; const updates = { board, lastMove: index }; if(gs.gameMode === 'timed' && gs.lastMoveTimestamp) { const elapsedSeconds = Math.floor((Date.now() - gs.lastMoveTimestamp.toDate().getTime()) / 1000); const currentTimers = {...gs.timers}; currentTimers[localPlayerSymbol] -= elapsedSeconds; updates.timers = currentTimers; } updates.lastMoveTimestamp = serverTimestamp(); const winningLine = checkForWin(index, board, localPlayerSymbol); if (winningLine) { updates.status = 'finished'; updates.winner = localPlayerSymbol; updates.winningLine = winningLine; updates.scores = gs.scores; updates.scores[localPlayerSymbol]++; } else if (board.every(cell => cell)) { updates.status = 'finished'; updates.winner = 'draw'; } else { updates.currentPlayer = localPlayerSymbol === 'X' ? 'O' : 'X'; } await updateDoc(gameRef, updates); if (updates.status !== 'finished' && isSinglePlayer && updates.currentPlayer === 'O') { aiMove(); } }
        function aiMove() { if (localGameState.status !== 'active' || localGameState.currentPlayer !== 'O') return; uiElements.statusText.textContent = `${localGameState.players.O.name.replace(/<br>/g, ' ')} gondolkodik...`; const thinkingTime = Math.floor(Math.random() * 2001) + 1000; setTimeout(async () => { if (localGameState.status !== 'active' || !currentGameId) return; const currentSnap = await getDoc(doc(db, 'games', currentGameId)); if (!currentSnap.exists() || currentSnap.data().currentPlayer !== 'O') return; const board = currentSnap.data().board; const bestMove = findBestMove([...board]); uiElements.sounds.place.play().catch(e => {}); const gameRef = doc(db, 'games', currentGameId); const newBoard = [...board]; newBoard[bestMove] = 'O'; const updates = { board: newBoard, lastMove: bestMove }; const winningLine = checkForWin(bestMove, newBoard, 'O'); if (winningLine) { updates.status = 'finished'; updates.winner = 'O'; updates.winningLine = winningLine; updates.scores = currentSnap.data().scores; updates.scores['O']++; } else if (newBoard.every(cell => cell)) { updates.status = 'finished'; updates.winner = 'draw'; } else { updates.currentPlayer = 'X'; } await updateDoc(gameRef, updates); }, thinkingTime); }
        function findBestMove(board) { const emptyCells = board.map((val, idx) => val === null ? idx : -1).filter(idx => idx !== -1); if (emptyCells.length === BOARD_SIZE * BOARD_SIZE) return Math.floor(BOARD_SIZE * BOARD_SIZE / 2); for (const index of emptyCells) { board[index] = 'O'; if (checkForWin(index, board, 'O')) { board[index] = null; return index; } board[index] = null; } for (const index of emptyCells) { board[index] = 'X'; if (checkForWin(index, board, 'X')) { board[index] = null; return index; } board[index] = null; } let bestScore = -1; let move = -1; for (const index of emptyCells) { const offensiveScore = getMoveScore(board, index, 'O'); const defensiveScore = getMoveScore(board, index, 'X'); const currentScore = Math.max(offensiveScore, defensiveScore); if (currentScore > bestScore) { bestScore = currentScore; move = index; } } return move === -1 ? emptyCells[Math.floor(Math.random() * emptyCells.length)] : move; }
        function getMoveScore(board, index, player) { board[index] = player; const score = evaluateBoardForPlayer(board, player); board[index] = null; return score; }
        function evaluateBoardForPlayer(board, player) { let totalScore = 0; const directions = [[1, 0], [0, 1], [1, 1], [1, -1]]; const opponent = player === 'X' ? 'O' : 'X'; for (let r = 0; r < BOARD_SIZE; r++) { for (let c = 0; c < BOARD_SIZE; c++) { if (board[r * BOARD_SIZE + c] !== player) continue; for (const [dr, dc] of directions) { let consecutive = 1; let openEnds = 0; for (let i = 1; i < 5; i++) { const nr = r + i * dr, nc = c + i * dc; if (nr < 0 || nr >= BOARD_SIZE || nc < 0 || nc >= BOARD_SIZE || board[nr * BOARD_SIZE + nc] === opponent) break; if (board[nr * BOARD_SIZE + nc] === player) consecutive++; else { if (board[nr * BOARD_SIZE + nc] === null) openEnds++; break; } } for (let i = 1; i < 5; i++) { const nr = r - i * dr, nc = c - i * dc; if (nr < 0 || nr >= BOARD_SIZE || nc < 0 || nc >= BOARD_SIZE || board[nr * BOARD_SIZE + nc] === opponent) break; if (board[nr * BOARD_SIZE + nc] === player) continue; else { if (board[nr * BOARD_SIZE + nc] === null) openEnds++; break; } } if (consecutive >= 5) totalScore += 1000000; else if (consecutive === 4 && openEnds === 2) totalScore += 50000; else if (consecutive === 4 && openEnds === 1) totalScore += 5000; else if (consecutive === 3 && openEnds === 2) totalScore += 1000; else if (consecutive === 3 && openEnds === 1) totalScore += 100; else if (consecutive === 2 && openEnds === 2) totalScore += 50; else if (consecutive === 2 && openEnds === 1) totalScore += 10; else if (consecutive === 1 && openEnds === 2) totalScore += 1; }}} return totalScore; }
        uiElements.resetBtn.addEventListener('click', async () => { if (localPlayerSymbol === 'spectator') return; const gameRef = doc(db, 'games', currentGameId); const gameSnap = await getDoc(gameRef); if (!gameSnap.exists()) return; const updates = { board: Array(BOARD_SIZE*BOARD_SIZE).fill(null), status: 'active', winner: null, currentPlayer: 'X', lastMove: null, winningLine: null, statusMessage: '' }; if (gameSnap.data().gameMode === 'timed') { updates.timers = { X: GAME_TIME_SECONDS, O: GAME_TIME_SECONDS }; updates.lastMoveTimestamp = serverTimestamp(); } await updateDoc(gameRef, updates); });
        function renderGame(gameState) { if (gameTimerInterval) clearInterval(gameTimerInterval); const { board, players, scores, currentPlayer, status, winner, winningLine, lastMove, gameMode, timers, lastMoveTimestamp, statusMessage, spectatorCode } = gameState; uiElements.spectatorCodeDisplay.textContent = `Leskel≈ëd≈ë K√≥d: ${spectatorCode}`; updateSpectatorListUI(); uiElements.board.innerHTML = ''; uiElements.board.style.gridTemplateColumns = `repeat(${BOARD_SIZE}, 1fr)`; board.forEach((cellValue, index) => { const cell = document.createElement('div'); cell.classList.add('cell'); if (cellValue) { cell.classList.add(cellValue === 'X' ? 'x-icon' : 'o-icon', 'cell-pop'); } if (winningLine && winningLine.includes(index)) { cell.classList.add('winning-cell'); } if (lastMove === index) { cell.classList.add('cell-flashed'); cell.addEventListener('animationend', () => { cell.classList.remove('cell-flashed'); }, { once: true }); } if (status === 'active' && !cellValue && currentPlayer === localPlayerSymbol && localPlayerSymbol !== 'spectator') { cell.addEventListener('click', () => handleCellClick(index)); } else { cell.classList.add('disabled'); } uiElements.board.appendChild(cell); }); uiElements.playerXName.innerHTML = players.X.name; uiElements.playerOName.innerHTML = players.O.name || 'V√°rakoz√°s...'; uiElements.playerXAvatar.style.backgroundImage = `url(${players.X.avatar})`; if(players.O.avatar) uiElements.playerOAvatar.style.backgroundImage = `url(${players.O.avatar})`; uiElements.scoreX.textContent = scores.X; uiElements.scoreO.textContent = scores.O; if(gameMode === 'timed' && timers) { uiElements.timerX.textContent = formatTime(timers.X); uiElements.timerO.textContent = formatTime(timers.O); if(status === 'active' && lastMoveTimestamp) { gameTimerInterval = setInterval(() => { const elapsedSeconds = Math.floor((Date.now() - lastMoveTimestamp.toDate().getTime()) / 1000); const remainingTime = timers[currentPlayer] - elapsedSeconds; const timerEl = currentPlayer === 'X' ? uiElements.timerX : uiElements.timerO; timerEl.textContent = formatTime(remainingTime > 0 ? remainingTime : 0); timerEl.classList.toggle('low-time', remainingTime <= 30); if(remainingTime <= 0 && currentPlayer === localPlayerSymbol && !isSinglePlayer && localPlayerSymbol !== 'spectator') { clearInterval(gameTimerInterval); handleTimeout(); } }, 1000); } } else { uiElements.timerX.textContent = ''; uiElements.timerO.textContent = ''; } uiElements.playerXPanel.classList.toggle('active', currentPlayer === 'X' && status === 'active'); uiElements.playerOPanel.classList.toggle('active', currentPlayer === 'O' && status === 'active'); if (status === 'waiting') { uiElements.statusText.textContent = `V√°rakoz√°s a m√°sik j√°t√©kosra... J√°t√©k k√≥d: ${currentGameId}`; } else if (status === 'active') { const isMyTurn = currentPlayer === localPlayerSymbol; uiElements.statusText.textContent = localPlayerSymbol === 'spectator' ? `${players[currentPlayer].name.replace(/<br>/g, ' ')} k√∂vetkezik...` : (isMyTurn ? 'Te k√∂vetkezel!' : `${players[currentPlayer].name.replace(/<br>/g, ' ')} k√∂vetkezik...`); } else if (status === 'finished') { if (gameState.isSinglePlayer) { let message = ''; const aiName = players.O.name.replace(/<br>/g, ' '); if (winner === 'O') { const quote = gameState.aiPersonality === 'panna' ? dailyPannaWinQuotes[Math.floor(Math.random() * dailyPannaWinQuotes.length)] : dailyKareszWinQuotes[Math.floor(Math.random() * dailyKareszWinQuotes.length)]; message = `${aiName} nyert! √úzenete: "${quote}"`; } else if (winner === 'X') { const quote = gameState.aiPersonality === 'panna' ? dailyPannaLossQuotes[Math.floor(Math.random() * dailyPannaLossQuotes.length)] : dailyKareszLossQuotes[Math.floor(Math.random() * dailyKareszLossQuotes.length)]; message = `Nyert√©l! ${aiName} √ºzenete: "${quote}"`; } else { const quote = gameState.aiPersonality === 'panna' ? dailyPannaDrawQuotes[Math.floor(Math.random() * dailyPannaDrawQuotes.length)] : dailyKareszDrawQuotes[Math.floor(Math.random() * dailyKareszDrawQuotes.length)]; message = `D√∂ntetlen! ${aiName} √ºzenete: "${quote}"`; } uiElements.statusText.textContent = message; } else { uiElements.statusText.textContent = statusMessage || (winner === 'draw' ? 'A j√°t√©k d√∂ntetlen!' : `${players[winner].name.replace(/<br>/g, ' ')} nyert!`); } if(winner !== 'draw' && winner === localPlayerSymbol) { uiElements.sounds.win.play().catch(e => {}); triggerVictoryConfetti(); } } uiElements.resetBtn.disabled = status !== 'finished' || localPlayerSymbol === 'spectator'; }
        function triggerVictoryConfetti() { const duration = 3 * 1000, animationEnd = Date.now() + duration; function randomInRange(min, max) { return Math.random() * (max - min) + min; } const interval = setInterval(function() { const timeLeft = animationEnd - Date.now(); if (timeLeft <= 0) { return clearInterval(interval); } const particleCount = 50 * (timeLeft / duration); const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 }; confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0, 0.1), y: Math.random() } })); confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.9, 1), y: Math.random() } })); }, 250); }
        function formatTime(seconds) { if (typeof seconds !== 'number' || seconds < 0) return "00:00"; const mins = Math.floor(seconds / 60); const secs = seconds % 60; return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; }
        async function handleTimeout() { const opponent = localPlayerSymbol === 'X' ? 'O' : 'X'; const gameRef = doc(db, 'games', currentGameId); const gameSnap = await getDoc(gameRef); if (!gameSnap.exists() || gameSnap.data().status === 'finished') return; const gs = gameSnap.data(); const scores = gs.scores; scores[opponent]++; await updateDoc(gameRef, { status: 'finished', winner: opponent, winningLine: null, scores: scores, statusMessage: `${gs.players[localPlayerSymbol].name} kifutott az id≈ëb≈ël.` }); }
        function checkForWin(index, board, player) { const col = index % BOARD_SIZE, row = Math.floor(index / BOARD_SIZE); const directions = [[0, 1], [1, 0], [1, 1], [1, -1]]; for (const [dx, dy] of directions) { let line = [index]; for (let i=1;i<5;i++) { const r=row+i*dy, c=col+i*dx, idx=r*BOARD_SIZE+c; if (r>=0&&r<BOARD_SIZE&&c>=0&&c<BOARD_SIZE&&board[idx]===player) line.push(idx); else break; } for (let i=1;i<5;i++) { const r=row-i*dy, c=col-i*dx, idx=r*BOARD_SIZE+c; if (r>=0&&r<BOARD_SIZE&&c>=0&&c<BOARD_SIZE&&board[idx]===player) line.push(idx); else break; } if (line.length>=5) return line; } return false; }
        function attachChatListener(gameId) { if(unsubscribeFromChat) unsubscribeFromChat(); const q=query(collection(db,'games',gameId,'chat'),orderBy('timestamp','asc')); unsubscribeFromChat=onSnapshot(q,(snapshot) => { uiElements.chatMessages.innerHTML=''; snapshot.forEach(doc => { const msg=doc.data(), msgEl=document.createElement('div'); msgEl.classList.add('chat-message'); if (msg.playerSymbol==='O') msgEl.classList.add('player-o'); msgEl.innerHTML=`<strong>${msg.sender}:</strong> ${msg.text}`; uiElements.chatMessages.appendChild(msgEl); }); uiElements.chatMessages.scrollTop=uiElements.chatMessages.scrollHeight; }); }
        async function sendChatMessage() { const text=uiElements.chatInput.value.trim(); if(text&&currentGameId&&localPlayerSymbol!=='spectator') { await addDoc(collection(db,'games',currentGameId,'chat'),{text:text,sender:localGameState.players[localPlayerSymbol].name,playerSymbol:localPlayerSymbol,timestamp:serverTimestamp()}); uiElements.chatInput.value=''; } }
        uiElements.sendBtn.addEventListener('click', sendChatMessage);
        uiElements.chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
        uiElements.copyBtn.addEventListener('click', () => { navigator.clipboard.writeText(currentGameId).then(() => { uiElements.copyBtn.textContent = 'M√°solva!'; setTimeout(() => { uiElements.copyBtn.textContent = 'M√°sol√°s'; }, 2000); }); });
        
        getDailyQuotes();
        initializeAvatars();
    </script>
</body>
</html>
